apiVersion: getambassador.io/v3alpha1
kind: Listener
metadata:
  name: emissary-ingress-listener-8080
  namespace: emissary
spec:
  hostBinding:
    namespace:
      from: ALL
  port: 8080
  protocol: HTTP
  securityModel: XFP
---
apiVersion: getambassador.io/v3alpha1
kind: Host
metadata:
  name: default-host
spec:
  hostname: '*'
  mappingSelector:
    matchLabels:
      defaulthost: host
  requestPolicy:
    insecure:
      action: Route
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: root-mapping
spec:
  prefix: /
  prefix_redirect: /lobbies
  service: lobbies-spa
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: words
spec:
  selector:
    matchLabels:
      app: words
  template:
    metadata:
      labels:
        app: words
    spec:
      containers:
        - image: ghcr.io/deesejohn/words:93a2912@sha256:7b79fceb1159ce43d0235657b62cb4a10d5b40a66bdf1821ca0458bfb86eae76
          livenessProbe:
            grpc:
              port: 50051
          name: server
          ports:
            - containerPort: 50051
---
apiVersion: v1
kind: Service
metadata:
  name: words
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
  selector:
    app: words
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: games
spec:
  selector:
    matchLabels:
      app: games
  template:
    metadata:
      labels:
        app: games
    spec:
      containers:
        - env:
            - name: NATS_HOST
              value: my-nats
            - name: REDIS_HOST
              value: games-redis-master
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: games-redis
            - name: WORDS_ADDRESS
              value: words:50051
          image: ghcr.io/deesejohn/games:93a2912@sha256:c2ec544016e0d24fb8e80ff232c8f25ed5e5ef37f59612c8042e26ad33b68fa6
          livenessProbe:
            grpc:
              port: 50051
          name: server
          ports:
            - containerPort: 50051
---
apiVersion: v1
kind: Service
metadata:
  name: games
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
  selector:
    app: games
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: games-bff
spec:
  selector:
    matchLabels:
      app: games-bff
  template:
    metadata:
      labels:
        app: games-bff
    spec:
      containers:
        - env:
            - name: GAMES_HOST
              value: games:50051
            - name: HOST_PREFIX
              value: /api/games
            - name: NATS_HOST
              value: my-nats
          image: ghcr.io/deesejohn/games-bff:93a2912@sha256:14a9492469d92681af363296e89992282007ca9e6b9d5c9794724e8c098baf52
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8000
            initialDelaySeconds: 5
          name: server
          ports:
            - containerPort: 8000
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8000
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: games-bff
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8000
  selector:
    app: games-bff
  type: ClusterIP
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: games-bff-mapping
spec:
  allow_upgrade:
    - websocket
  prefix: /api/games/
  service: games-bff
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: games-spa
spec:
  selector:
    matchLabels:
      app: games-spa
  template:
    metadata:
      labels:
        app: games-spa
    spec:
      containers:
        - image: ghcr.io/deesejohn/games-spa:93a2912@sha256:37088b7dd8b895dff0eab07d8f9e489421d05111791a29c3660c149fd0e8676b
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
          name: server
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: games-spa
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: games-spa
  type: ClusterIP
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: games-spa-mapping
spec:
  prefix: /games
  service: games-spa
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobbies
spec:
  selector:
    matchLabels:
      app: lobbies
  template:
    metadata:
      labels:
        app: lobbies
    spec:
      containers:
        - env:
            - name: ASPNETCORE_FORWARDEDHEADERS_ENABLED
              value: "true"
            - name: GAMES_HOST
              value: http://games:50051
            - name: HOST_PREFIX
              value: /api/lobbies
            - name: PLAYERS_HOST
              value: http://players
            - name: REDIS_HOST
              value: lobbies-redis-master
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: lobbies-redis
          image: ghcr.io/deesejohn/lobbies:93a2912@sha256:a5149115f1823341244d17ab5a4385751f9d24441ddde1f3ef99bf3336043654
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: lobbies
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: lobbies
  type: ClusterIP
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: lobbies-mapping
spec:
  allow_upgrade:
    - websocket
  prefix: /api/lobbies/
  service: lobbies
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobbies-spa
spec:
  selector:
    matchLabels:
      app: lobbies-spa
  template:
    metadata:
      labels:
        app: lobbies-spa
    spec:
      containers:
        - image: ghcr.io/deesejohn/lobbies-spa:93a2912@sha256:9c368a0c9f731240c9c48ffa5e67fa2c8e50e5e047d982e84eb90bceeaec25b5
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
          name: server
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: lobbies-spa
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: lobbies-spa
  type: ClusterIP
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: lobbies-spa-mapping
spec:
  prefix: /lobbies
  service: lobbies-spa
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: players
spec:
  selector:
    matchLabels:
      app: players
  template:
    metadata:
      labels:
        app: players
    spec:
      containers:
        - env:
            - name: HOST_PREFIX
              value: /api/players
            - name: REDIS_HOST
              value: players-redis-master
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: players-redis
          image: ghcr.io/deesejohn/players:93a2912@sha256:cf62ce290bb2ba57b73d61bd5f19df999a9927d9a04b2b9540855626dd4ca5a4
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: players
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: players
  type: ClusterIP
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: players-mapping
spec:
  prefix: /api/players/
  service: players
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: players-spa
spec:
  selector:
    matchLabels:
      app: players-spa
  template:
    metadata:
      labels:
        app: players-spa
    spec:
      containers:
        - image: ghcr.io/deesejohn/players-spa:93a2912@sha256:1d0feaab114e2bc7f5443e93c895a433f7e58683462b34a6cef587614b9eb45a
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
          name: server
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: players-spa
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: players-spa
  type: ClusterIP
---
apiVersion: getambassador.io/v3alpha1
kind: Mapping
metadata:
  labels:
    defaulthost: host
  name: players-spa-mapping
spec:
  prefix: /players
  service: players-spa
